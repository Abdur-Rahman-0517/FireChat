<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FireChat Messenger</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            overflow: hidden;
            overscroll-behavior: contain;
            touch-action: pan-y;
        }

        /* App Container */
        #app-container {
            width: 100%;
            height: 100vh;
            max-width: 1200px;
            display: flex;
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.3);
        }

        /* Intro Page Styles */
        #intro-page {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            height: 100vh;
            width: 100%;
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1000;
            animation: fadeOut 1s ease-in-out 3s forwards;
        }

        #intro-page h1 {
            font-size: 4rem;
            color: #fff;
            text-shadow: 2px 2px 10px rgba(0, 0, 0, 0.3);
            animation: zoomIn 1s ease-in-out;
            margin-bottom: 20px;
        }

        #intro-page p {
            font-size: 1.2rem;
            color: rgba(255, 255, 255, 0.8);
            margin-top: 10px;
            animation: fadeIn 1s ease-in-out;
        }

        .intro-logo {
            width: 150px;
            height: 150px;
            background: linear-gradient(135deg, #4facfe, #00f2fe);
            border-radius: 30%;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            animation: float 3s ease-in-out infinite;
        }

        .intro-logo i {
            font-size: 70px;
            color: white;
        }

        @keyframes zoomIn {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; visibility: hidden; }
        }

        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-20px); }
            100% { transform: translateY(0px); }
        }

        /* Auth Page Styles */
        #auth-page {
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            height: 100vh;
            width: 100%;
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            position: absolute;
            top: 0;
            left: 0;
            z-index: 999;
            animation: fadeIn 0.5s ease-in-out;
        }

        .auth-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        #auth-page h2 {
            font-size: 2.2rem;
            color: #fff;
            margin-bottom: 30px;
            font-weight: 600;
        }

        .input-group {
            position: relative;
            margin-bottom: 20px;
        }

        #auth-page input {
            padding: 15px 20px 15px 50px;
            font-size: 1rem;
            border: none;
            border-radius: 50px;
            outline: none;
            width: 100%;
            background: rgba(255, 255, 255, 0.15);
            color: white;
            transition: all 0.3s ease;
        }

        #auth-page input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        #auth-page input:focus {
            background: rgba(255, 255, 255, 0.25);
            box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.3);
        }

        .input-icon {
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            color: rgba(255, 255, 255, 0.7);
        }

        #auth-page button {
            padding: 15px;
            font-size: 1.1rem;
            background: linear-gradient(135deg, #4facfe, #00f2fe);
            color: white;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            width: 100%;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        #auth-page button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        }

        #toggle-auth {
            margin-top: 20px;
            color: rgba(255, 255, 255, 0.8);
            cursor: pointer;
            text-decoration: none;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        #toggle-auth:hover {
            color: white;
            text-decoration: underline;
        }

        #continue-as {
            margin-top: 20px;
            padding: 15px;
            font-size: 1rem;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            width: 100%;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        #continue-as:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-3px);
        }

        .continue-as-avatar {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-size: cover;
            background-position: center;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
        }

        /* Profile picture preview */
        #profile-pic-preview {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            margin: 10px auto;
            background-size: cover;
            background-position: center;
            border: 2px solid rgba(255, 255, 255, 0.3);
            display: none;
        }

        /* Chat Menu Page Styles */
        #chat-menu-page {
            display: none;
            flex-direction: column;
            height: 100%;
            width: 100%;
            background: rgba(25, 25, 40, 0.95);
            z-index: 998;
            animation: fadeIn 0.5s ease-in-out;
            overflow: hidden;
        }

        .menu-header {
            padding: 20px;
            background: rgba(35, 35, 55, 0.95);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .menu-header h2 {
            font-size: 1.8rem;
            color: white;
            font-weight: 600;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-weight: bold;
            font-size: 1.2rem;
            background-size: cover;
            background-position: center;
        }

        .user-name {
            color: white;
            font-weight: 600;
            font-size: 1.1rem;
        }

        .logout-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: rgba(255, 255, 255, 0.8);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.2rem;
        }

        .logout-btn:hover {
            background: rgba(255, 80, 80, 0.2);
            color: white;
        }

        #user-list {
            list-style: none;
            padding: 20px;
            width: 100%;
            height: 100%;
            overflow-y: auto;
        }

        #user-list li {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 15px;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        #user-list li:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(5px);
        }

        #user-list img {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid rgba(255, 255, 255, 0.1);
        }

        .user-details {
            flex: 1;
        }

        .user-details h3 {
            color: white;
            font-size: 1.1rem;
            margin-bottom: 5px;
        }

        .user-details p {
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.9rem;
        }

        .user-status {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }

        .online-dot {
            width: 10px;
            height: 10px;
            background-color: #00e676;
            border-radius: 50%;
            margin-bottom: 5px;
        }

        .last-seen {
            color: rgba(255, 255, 255, 0.4);
            font-size: 0.8rem;
        }

        /* Main Chat Page Styles */
        #main-content {
            display: none;
            flex-direction: column;
            width: 100%;
            height: 100vh;
            animation: fadeIn 0.5s ease-in-out;
            background: rgba(30, 30, 45, 0.95);
        }

        #chat-header {
            width: 100%;
            background: rgba(35, 35, 55, 0.95);
            padding: 15px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .chat-partner {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .chat-partner-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-weight: bold;
            font-size: 1.1rem;
            background-size: cover;
            background-position: center;
        }

        .partner-info h3 {
            color: white;
            font-size: 1.2rem;
            margin-bottom: 3px;
        }

        .partner-info p {
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.9rem;
        }

        .chat-actions {
            display: flex;
            gap: 15px;
        }

        .chat-action-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: rgba(255, 255, 255, 0.8);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.1rem;
        }

        .chat-action-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        #chat-box {
            width: 100%;
            height: calc(100vh - 140px);
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            flex-grow: 1;
            overscroll-behavior: contain;
        }

        .message {
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 15px 20px;
            max-width: 80%;
            font-size: 16px;
            color: white;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            word-wrap: break-word;
            position: relative;
            animation: fadeIn 0.3s ease-out;
        }

        .sent {
            background: linear-gradient(135deg, #4facfe, #00f2fe);
            align-self: flex-end;
            border-bottom-right-radius: 5px;
        }

        .received {
            background: rgba(255, 255, 255, 0.15);
            align-self: flex-start;
            border-bottom-left-radius: 5px;
        }

        .message-content {
            margin-bottom: 5px;
            line-height: 1.5;
        }

        .timestamp {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.6);
            text-align: right;
        }

        .date-label {
            text-align: center;
            font-size: 14px;
            color: rgba(255, 255, 255, 0.4);
            margin: 20px 0;
            position: relative;
        }

        .date-label::before,
        .date-label::after {
            content: '';
            position: absolute;
            top: 50%;
            width: 30%;
            height: 1px;
            background: rgba(255, 255, 255, 0.1);
        }

        .date-label::before {
            left: 0;
        }

        .date-label::after {
            right: 0;
        }

        .message-input-container {
            display: flex;
            width: 100%;
            padding: 15px 20px;
            background: rgba(35, 35, 55, 0.95);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .input-wrapper {
            display: flex;
            flex-grow: 1;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 30px;
            padding: 5px 15px;
            align-items: center;
        }

        .input-actions {
            display: flex;
            gap: 10px;
        }

        .action-btn {
            background: transparent;
            border: none;
            color: rgba(255, 255, 255, 0.7);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.2rem;
        }

        .action-btn:hover {
            color: white;
            background: rgba(255, 255, 255, 0.1);
        }

        #message {
            flex-grow: 1;
            padding: 12px;
            font-size: 16px;
            border: none;
            outline: none;
            background: transparent;
            color: white;
        }

        #message::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        #sendBtn {
            padding: 12px 20px;
            font-size: 16px;
            background: linear-gradient(135deg, #4facfe, #00f2fe);
            color: white;
            border: none;
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.2rem;
            width: 45px;
            height: 45px;
        }

        #sendBtn:hover {
            transform: scale(1.05);
        }

        /* Notification System */
        #notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: #fff;
            padding: 15px 25px;
            border-radius: 10px;
            display: none;
            z-index: 1001;
            animation: slideInRight 0.5s ease-in-out;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        /* Typing Indicator */
        .typing-indicator {
            display: none;
            align-items: center;
            padding: 10px 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            margin: 5px 0 10px;
            align-self: flex-start;
            width: auto;
            max-width: 120px;
            animation: fadeIn 0.3s ease;
        }

        .typing-dots {
            display: flex;
            gap: 5px;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            background: rgba(255, 255, 255, 0.6);
            border-radius: 50%;
            animation: typing 1.5s infinite;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-5px); }
        }

        /* Keyframes for Animations */
        @keyframes slideInDown {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        @keyframes slideInUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        @keyframes slideInRight {
            from { transform: translateX(50px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .auth-card {
                padding: 30px 20px;
            }
            
            #intro-page h1 {
                font-size: 2.5rem;
            }
            
            .intro-logo {
                width: 120px;
                height: 120px;
            }
            
            .intro-logo i {
                font-size: 50px;
            }
            
            .menu-header h2 {
                font-size: 1.5rem;
            }
            
            .user-avatar {
                width: 40px;
                height: 40px;
                font-size: 1rem;
            }
            
            .user-name {
                font-size: 1rem;
            }
            
            #continue-as {
                padding: 12px;
                font-size: 0.9rem;
            }
        }
    </style>
</head>
<body>
    <div id="app-container">
        <!-- Intro Page -->
        <div id="intro-page">
            <div class="intro-logo">
                <i class="fas fa-fire"></i>
            </div>
            <h1>FireChat</h1>
            <p>Secure Real-time Messenger</p>
            <p>Made By Abdur Rahman</p>
        </div>

        <!-- Auth Page -->
        <div id="auth-page">
            <div class="auth-card">
                <h2 id="auth-title">Sign In</h2>
                
                <!-- Profile picture preview -->
                <div id="profile-pic-preview"></div>
                
                <div class="input-group">
                    <i class="fas fa-phone input-icon"></i>
                    <input type="text" id="phone" placeholder="Phone Number">
                </div>
                <div class="input-group">
                    <i class="fas fa-lock input-icon"></i>
                    <input type="password" id="password" placeholder="Password">
                </div>
                <div class="input-group" style="display: none;">
                    <i class="fas fa-user input-icon"></i>
                    <input type="text" id="name" placeholder="Full Name">
                </div>
                <div class="input-group" style="display: none;">
                    <i class="fas fa-image input-icon"></i>
                    <input type="file" id="profile-pic" placeholder="Profile Picture" accept="image/*">
                </div>
                <button id="auth-button">Sign In</button>
                <p id="toggle-auth">Don't have an account? Sign Up</p>
                <button id="continue-as" style="display: none;">
                    <div class="continue-as-avatar" id="saved-user-avatar"></div>
                    <span>Continue as <span id="saved-username"></span></span>
                </button>
            </div>
        </div>

        <!-- Chat Menu Page -->
        <div id="chat-menu-page">
            <div class="menu-header">
                <h2>Chats</h2>
                <div class="user-info">
                    <div class="user-avatar" id="current-user-avatar">AR</div>
                    <div class="user-name" id="current-user-name">Loading...</div>
                    <button class="logout-btn">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </div>
            <ul id="user-list">
                <!-- Users will be populated dynamically -->
                <li>
                    <div class="user-avatar" style="background: linear-gradient(135deg, #ff9a9e, #fad0c4);">S</div>
                    <div class="user-details">
                        <h3>Sarah Johnson</h3>
                        <p>+1 (555) 123-4567</p>
                    </div>
                    <div class="user-status">
                        <div class="online-dot"></div>
                        <span class="last-seen">Online</span>
                    </div>
                </li>
                <li>
                    <div class="user-avatar" style="background: linear-gradient(135deg, #a1c4fd, #c2e9fb);">M</div>
                    <div class="user-details">
                        <h3>Mike Thompson</h3>
                        <p>+1 (555) 987-6543</p>
                    </div>
                    <div class="user-status">
                        <span class="last-seen">2h ago</span>
                    </div>
                </li>
                <li>
                    <div class="user-avatar" style="background: linear-gradient(135deg, #d4fc79, #96e6a1);">E</div>
                    <div class="user-details">
                        <h3>Emma Davis</h3>
                        <p>+1 (555) 456-7890</p>
                    </div>
                    <div class="user-status">
                        <div class="online-dot"></div>
                        <span class="last-seen">Online</span>
                    </div>
                </li>
            </ul>
        </div>

        <!-- Main Chat Page -->
        <div id="main-content">
            <div id="chat-header">
                <div class="chat-partner">
                    <button class="back-btn chat-action-btn">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                    <div class="chat-partner-avatar" id="recipient-avatar">U</div>
                    <div class="partner-info">
                        <h3 id="recipient-name">User</h3>
                        <p id="recipient-status">Online</p>
                    </div>
                </div>
                <div class="chat-actions">
                    <button class="chat-action-btn">
                        <i class="fas fa-phone-alt"></i>
                    </button>
                    <button class="chat-action-btn">
                        <i class="fas fa-video"></i>
                    </button>
                    <button class="chat-action-btn">
                        <i class="fas fa-ellipsis-v"></i>
                    </button>
                </div>
            </div>
            <div id="chat-box">
                <div class="date-label">Today</div>
                <div class="message received">
                    <div class="message-content">Hey there! How are you doing today?</div>
                    <div class="timestamp">10:15 AM</div>
                </div>
                <div class="message sent">
                    <div class="message-content">I'm doing great! Just finished the FireChat app with the new Continue As feature.</div>
                    <div class="timestamp">10:16 AM</div>
                </div>
                <div class="message received">
                    <div class="message-content">That's awesome! How does the Continue As feature work?</div>
                    <div class="timestamp">10:17 AM</div>
                </div>
                <div class="message sent">
                    <div class="message-content">It remembers your login so you can quickly resume your session. Very convenient!</div>
                    <div class="timestamp">10:18 AM</div>
                </div>
                <div class="message received">
                    <div class="message-content">Nice! Looking forward to trying it out. When will it be ready?</div>
                    <div class="timestamp">10:20 AM</div>
                </div>
                <div class="message sent">
                    <div class="message-content">It's already implemented and working perfectly!</div>
                    <div class="timestamp">10:21 AM</div>
                </div>
            </div>
            <div class="message-input-container">
                <div class="input-wrapper">
                    <button class="action-btn">
                        <i class="fas fa-paperclip"></i>
                    </button>
                    <input type="text" id="message" placeholder="Type a message...">
                    <button class="action-btn">
                        <i class="fas fa-smile"></i>
                    </button>
                    <button class="action-btn">
                        <i class="fas fa-camera"></i>
                    </button>
                </div>
                <button id="sendBtn">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>

        <!-- Notification System -->
        <div id="notification"></div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <script>
        // Your Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCTsAz5S3wfA-MVf6Cg0fIhgIJpXJVtUeM",
            authDomain: "firechat-1db95.firebaseapp.com",
            projectId: "firechat-1db95",
            storageBucket: "firechat-1db95.appspot.com",
            messagingSenderId: "415882699232",
            appId: "1:415882699232:web:9bff72b320ad3d2f14cb85",
            measurementId: "G-HS72PGXV62"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // DOM Elements
        const introPage = document.getElementById('intro-page');
        const authPage = document.getElementById('auth-page');
        const chatMenuPage = document.getElementById('chat-menu-page');
        const mainContent = document.getElementById('main-content');
        const notification = document.getElementById('notification');
        const authButton = document.getElementById('auth-button');
        const toggleAuth = document.getElementById('toggle-auth');
        const continueAsButton = document.getElementById('continue-as');
        const savedUsername = document.getElementById('saved-username');
        const savedUserAvatar = document.getElementById('saved-user-avatar');
        const backBtn = document.querySelector('.back-btn');
        const sendBtn = document.getElementById('sendBtn');
        const messageInput = document.getElementById('message');
        const chatBox = document.getElementById('chat-box');
        const userList = document.getElementById('user-list');
        const currentUserAvatar = document.getElementById('current-user-avatar');
        const currentUserName = document.getElementById('current-user-name');
        const recipientName = document.getElementById('recipient-name');
        const recipientAvatar = document.getElementById('recipient-avatar');
        const recipientStatus = document.getElementById('recipient-status');
        const logoutBtn = document.querySelector('.logout-btn');
        const profilePicInput = document.getElementById('profile-pic');
        const profilePicPreview = document.getElementById('profile-pic-preview');
        const typingIndicator = document.createElement('div');
        typingIndicator.className = 'typing-indicator';
        typingIndicator.innerHTML = `
            <div class="typing-dots">
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
            </div>
        `;

        // App State
        let currentUser = null;
        let currentChatId = null;
        let currentRecipient = null;
        let isSignUp = false;
        let unsubscribeMessages = null;

        // Show auth page after intro page
        setTimeout(() => {
            introPage.style.display = 'none';
            authPage.style.display = 'flex';
        }, 3000);

        // Show notification
        function showNotification(message, duration = 3000) {
            notification.textContent = message;
            notification.style.display = 'block';
            setTimeout(() => {
                notification.style.display = 'none';
            }, duration);
        }

        // Toggle between Sign In and Sign Up
        const authTitle = document.getElementById('auth-title');
        const nameInput = document.querySelector('#name').parentElement;
        const profilePicContainer = document.querySelector('#profile-pic').parentElement;

        toggleAuth.addEventListener('click', () => {
            isSignUp = !isSignUp;
            authTitle.textContent = isSignUp ? "Sign Up" : "Sign In";
            authButton.textContent = isSignUp ? "Sign Up" : "Sign In";
            toggleAuth.textContent = isSignUp ? "Already have an account? Sign In" : "Don't have an account? Sign Up";
            nameInput.style.display = isSignUp ? 'block' : 'none';
            profilePicContainer.style.display = isSignUp ? 'block' : 'none';
        });

        // Profile picture preview
        profilePicInput.addEventListener('change', function() {
            if (this.files && this.files[0]) {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    profilePicPreview.style.backgroundImage = `url(${e.target.result})`;
                    profilePicPreview.style.display = 'block';
                }
                
                reader.readAsDataURL(this.files[0]);
            }
        });

        // Optimize and compress image
        async function optimizeImage(file) {
            return new Promise((resolve, reject) => {
                // Skip optimization for small files
                if (file.size < 500 * 1024) { // Less than 500KB
                    const reader = new FileReader();
                    reader.onload = (e) => resolve(e.target.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                    return;
                }
                
                const img = new Image();
                const url = URL.createObjectURL(file);
                
                img.onload = () => {
                    // Create canvas for resizing
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    // Calculate new dimensions (max 800px on longest side)
                    let width = img.width;
                    let height = img.height;
                    const maxSize = 800;
                    
                    if (width > height) {
                        if (width > maxSize) {
                            height *= maxSize / width;
                            width = maxSize;
                        }
                    } else {
                        if (height > maxSize) {
                            width *= maxSize / height;
                            height = maxSize;
                        }
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    
                    // Draw and compress image
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // Get compressed data URL
                    const compressedDataUrl = canvas.toDataURL('image/jpeg', 0.7);
                    URL.revokeObjectURL(url);
                    resolve(compressedDataUrl);
                };
                
                img.onerror = reject;
                img.src = url;
            });
        }

        // Handle Sign Up
        async function handleSignUp(phone, password, name, profilePic) {
            try {
                // Check if user already exists
                const userDoc = await db.collection('users').doc(phone).get();
                
                if (userDoc.exists) {
                    throw new Error('User with this phone number already exists');
                }
                
                // Create new user
                await db.collection('users').doc(phone).set({
                    name,
                    password,
                    phone,
                    Pic: profilePic || '',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                return { phone, name, Pic: profilePic };
            } catch (error) {
                console.error("Error signing up:", error);
                throw error;
            }
        }

        // Handle Sign In
        async function handleSignIn(phone, password) {
            try {
                const userDoc = await db.collection('users').doc(phone).get();
                if (!userDoc.exists) {
                    throw new Error('User not found');
                }
                
                const userData = userDoc.data();
                if (userData.password !== password) {
                    throw new Error('Incorrect password');
                }
                
                return userData;
            } catch (error) {
                console.error("Error signing in:", error);
                throw error;
            }
        }

        // Helper function to update avatar display
        function updateAvatar(element, user) {
            element.textContent = '';
            element.style.backgroundImage = '';
            element.style.background = '';
            
            if (user.Pic) {
                element.style.backgroundImage = `url(${user.Pic})`;
            } else {
                element.style.background = getRandomGradient();
                element.textContent = user.name.charAt(0).toUpperCase();
            }
        }

        // Auth button click handler
        authButton.addEventListener('click', async () => {
            const phone = document.getElementById('phone').value.trim();
            const password = document.getElementById('password').value.trim();
            const name = document.getElementById('name').value.trim();
            const profilePicFile = document.getElementById('profile-pic').files[0];
            
            // Validate inputs
            if (!phone || !password || (isSignUp && !name)) {
                showNotification("Please fill in all fields.");
                return;
            }
            
            // Validate phone format
            if (!/^\d+$/.test(phone)) {
                showNotification("Please enter a valid phone number (digits only)");
                return;
            }
            
            try {
                if (isSignUp) {
                    // Handle sign up
                    let profilePic = null;
                    if (profilePicFile) {
                        // Optimize image if needed
                        profilePic = await optimizeImage(profilePicFile);
                    }
                    
                    const user = await handleSignUp(phone, password, name, profilePic);
                    
                    // Update UI
                    currentUser = user;
                    
                    // Set avatar
                    updateAvatar(currentUserAvatar, currentUser);
                    
                    currentUserName.textContent = currentUser.name;
                    
                    // Save to localStorage for auto-login
                    localStorage.setItem('firechat_user', JSON.stringify({
                        phone,
                        name,
                        Pic: profilePic || '',
                        password: password
                    }));
                    
                    showNotification("Account created successfully!");
                    
                    // Switch to chat menu
                    authPage.style.display = 'none';
                    chatMenuPage.style.display = 'flex';
                    
                    // Load user list
                    loadUserList();
                } else {
                    // Handle sign in
                    const userData = await handleSignIn(phone, password);
                    
                    // Update UI and state
                    currentUser = userData;
                    
                    // Set avatar
                    updateAvatar(currentUserAvatar, currentUser);
                    
                    currentUserName.textContent = currentUser.name;
                    
                    // Save to localStorage for auto-login
                    localStorage.setItem('firechat_user', JSON.stringify({
                        phone,
                        name: currentUser.name,
                        Pic: currentUser.Pic || '',
                        password: password
                    }));
                    
                    showNotification("Signed in successfully!");
                    
                    // Switch to chat menu
                    authPage.style.display = 'none';
                    chatMenuPage.style.display = 'flex';
                    
                    // Load user list
                    loadUserList();
                }
            } catch (error) {
                console.error("Authentication error:", error);
                showNotification(error.message || "Authentication failed. Please try again.");
            }
        });

        // Auto-login with saved credentials
        const savedUser = JSON.parse(localStorage.getItem('firechat_user'));
        if (savedUser) {
            continueAsButton.style.display = 'flex';
            savedUsername.textContent = savedUser.name;
            
            // Set avatar for continue as button
            if (savedUser.Pic) {
                savedUserAvatar.style.backgroundImage = `url(${savedUser.Pic})`;
            } else {
                savedUserAvatar.style.background = getRandomGradient();
                savedUserAvatar.textContent = savedUser.name.charAt(0).toUpperCase();
            }
            
            continueAsButton.addEventListener('click', async () => {
                try {
                    const userData = await handleSignIn(savedUser.phone, savedUser.password);
                    
                    if (!userData) {
                        throw new Error("User data not found");
                    }
                    
                    currentUser = userData;
                    
                    // Set avatar
                    updateAvatar(currentUserAvatar, currentUser);
                    
                    currentUserName.textContent = currentUser.name;
                    
                    showNotification("Welcome back, " + currentUser.name + "!");
                    authPage.style.display = 'none';
                    chatMenuPage.style.display = 'flex';
                    
                    // Load user list
                    loadUserList();
                } catch (error) {
                    console.error("Auto-login error:", error);
                    showNotification("Auto-login failed. Please sign in manually.");
                }
            });
        }

        // Helper function for random gradient
        function getRandomGradient() {
            const gradients = [
                'linear-gradient(135deg, #ff9a9e, #fad0c4)',
                'linear-gradient(135deg, #a1c4fd, #c2e9fb)',
                'linear-gradient(135deg, #d4fc79, #96e6a1)',
                'linear-gradient(135deg, #f6d365, #fda085)',
                'linear-gradient(135deg, #84fab0, #8fd3f4)'
            ];
            return gradients[Math.floor(Math.random() * gradients.length)];
        }

        // Load user list from Firestore
        async function loadUserList() {
            try {
                const usersSnapshot = await db.collection('users').get();
                userList.innerHTML = '';
                
                usersSnapshot.forEach(doc => {
                    const user = doc.data();
                    
                    // Skip current user
                    if (user.phone === currentUser.phone) return;
                    
                    const li = document.createElement('li');
                    
                    // Create avatar
                    const avatarDiv = document.createElement('div');
                    avatarDiv.className = 'user-avatar';
                    if (user.Pic) {
                        avatarDiv.style.backgroundImage = `url(${user.Pic})`;
                    } else {
                        avatarDiv.style.background = getRandomGradient();
                        avatarDiv.textContent = user.name.charAt(0).toUpperCase();
                    }
                    
                    // Create user details
                    const userDetailsDiv = document.createElement('div');
                    userDetailsDiv.className = 'user-details';
                    userDetailsDiv.innerHTML = `
                        <h3>${user.name}</h3>
                        <p>${user.phone}</p>
                    `;
                    
                    // Create user status
                    const userStatusDiv = document.createElement('div');
                    userStatusDiv.className = 'user-status';
                    userStatusDiv.innerHTML = `
                        <span class="last-seen">Offline</span>
                    `;
                    
                    // Append elements
                    li.appendChild(avatarDiv);
                    li.appendChild(userDetailsDiv);
                    li.appendChild(userStatusDiv);
                    
                    li.addEventListener('click', () => startChat(user.phone, user));
                    userList.appendChild(li);
                });
                
                if (userList.children.length === 0) {
                    userList.innerHTML = '<li>No other users available.</li>';
                }
            } catch (error) {
                console.error("Error loading user list:", error);
                showNotification("Failed to load user list.");
            }
        }

        // Start a chat with another user
        async function startChat(recipientPhone, recipientData) {
            try {
                currentRecipient = recipientData;
                recipientName.textContent = currentRecipient.name;
                
                // Set recipient avatar
                recipientAvatar.textContent = '';
                if (currentRecipient.Pic) {
                    recipientAvatar.style.backgroundImage = `url(${currentRecipient.Pic})`;
                } else {
                    recipientAvatar.style.background = getRandomGradient();
                    recipientAvatar.textContent = currentRecipient.name.charAt(0).toUpperCase();
                }
                
                recipientStatus.textContent = 'Online';
                
                // Check if chat already exists
                const chatsQuery = await db.collection('chats')
                    .where('participants', 'array-contains', currentUser.phone)
                    .get();
                
                let chatExists = false;
                
                chatsQuery.forEach(doc => {
                    const chat = doc.data();
                    if (chat.participants.includes(recipientPhone)) {
                        chatExists = true;
                        currentChatId = doc.id;
                    }
                });
                
                // Create new chat if doesn't exist
                if (!chatExists) {
                    const newChat = {
                        participants: [currentUser.phone, recipientPhone],
                        names: {
                            [currentUser.phone]: currentUser.name,
                            [recipientPhone]: currentRecipient.name
                        },
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        lastMessage: '',
                        lastMessageTime: firebase.firestore.FieldValue.serverTimestamp()
                    };
                    
                    const chatRef = await db.collection('chats').add(newChat);
                    currentChatId = chatRef.id;
                }
                
                // Load messages
                loadMessages();
                
                // Switch to chat view
                chatMenuPage.style.display = 'none';
                mainContent.style.display = 'flex';
            } catch (error) {
                console.error("Error starting chat:", error);
                showNotification("Failed to start chat.");
            }
        }

        // Load messages for current chat
        function loadMessages() {
            // Unsubscribe from previous listener if exists
            if (unsubscribeMessages) {
                unsubscribeMessages();
            }
            
            chatBox.innerHTML = '';
            let lastDate = null;
            
            unsubscribeMessages = db.collection('chats')
                .doc(currentChatId)
                .collection('messages')
                .orderBy('timestamp', 'asc')
                .onSnapshot(snapshot => {
                    chatBox.innerHTML = '';
                    lastDate = null;
                    
                    snapshot.forEach(doc => {
                        const message = doc.data();
                        const messageDate = message.timestamp.toDate().toDateString();
                        
                        // Add date label if new day
                        if (messageDate !== lastDate) {
                            const dateLabel = document.createElement('div');
                            dateLabel.className = 'date-label';
                            dateLabel.textContent = message.timestamp.toDate().toLocaleDateString('en-US', {
                                weekday: 'short',
                                month: 'short',
                                day: 'numeric'
                            });
                            chatBox.appendChild(dateLabel);
                            lastDate = messageDate;
                        }
                        
                        // Create message element
                        const messageElement = document.createElement('div');
                        messageElement.className = `message ${message.sender === currentUser.phone ? 'sent' : 'received'}`;
                        
                        const messageContent = document.createElement('div');
                        messageContent.className = 'message-content';
                        messageContent.textContent = message.text;
                        
                        const timestamp = document.createElement('div');
                        timestamp.className = 'timestamp';
                        timestamp.textContent = message.timestamp.toDate().toLocaleTimeString('en-US', {
                            hour: 'numeric',
                            minute: 'numeric',
                            hour12: true
                        });
                        
                        messageElement.appendChild(messageContent);
                        messageElement.appendChild(timestamp);
                        chatBox.appendChild(messageElement);
                    });
                    
                    // Scroll to bottom
                    chatBox.scrollTop = chatBox.scrollHeight;
                }, error => {
                    console.error("Error loading messages:", error);
                    showNotification("Failed to load messages.");
                });
        }

        // Send a message
        async function sendMessage() {
            const messageText = messageInput.value.trim();
            
            if (!messageText || !currentChatId) return;
            
            try {
                // Add message to Firestore
                await db.collection('chats')
                    .doc(currentChatId)
                    .collection('messages')
                    .add({
                        text: messageText,
                        sender: currentUser.phone,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });
                
                // Update last message in chat
                await db.collection('chats')
                    .doc(currentChatId)
                    .update({
                        lastMessage: messageText,
                        lastMessageTime: firebase.firestore.FieldValue.serverTimestamp()
                    });
                
                // Clear input
                messageInput.value = '';
            } catch (error) {
                console.error("Error sending message:", error);
                showNotification("Failed to send message.");
            }
        }

        // Event listeners
        sendBtn.addEventListener('click', sendMessage);
        messageInput.addEventListener('keypress', e => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        backBtn.addEventListener('click', () => {
            mainContent.style.display = 'none';
            chatMenuPage.style.display = 'flex';
            
            // Unsubscribe from messages when leaving chat
            if (unsubscribeMessages) {
                unsubscribeMessages();
                unsubscribeMessages = null;
            }
        });

        logoutBtn.addEventListener('click', () => {
            localStorage.removeItem('firechat_user');
            currentUser = null;
            currentChatId = null;
            currentRecipient = null;
            
            chatMenuPage.style.display = 'none';
            mainContent.style.display = 'none';
            authPage.style.display = 'flex';
            
            showNotification("You've been signed out");
        });

        // Initialize typing indicator
        chatBox.appendChild(typingIndicator);
        
        // Simulate loading of user list
        setTimeout(() => {
            if (userList) {
                userList.innerHTML = `
                    <li>
                        <div class="user-avatar" style="background: linear-gradient(135deg, #ff9a9e, #fad0c4);">S</div>
                        <div class="user-details">
                            <h3>Sarah Johnson</h3>
                            <p>+1 (555) 123-4567</p>
                        </div>
                        <div class="user-status">
                            <div class="online-dot"></div>
                            <span class="last-seen">Online</span>
                        </div>
                    </li>
                    <li>
                        <div class="user-avatar" style="background: linear-gradient(135deg, #a1c4fd, #c2e9fb);">M</div>
                        <div class="user-details">
                            <h3>Mike Thompson</h3>
                            <p>+1 (555) 987-6543</p>
                        </div>
                        <div class="user-status">
                            <span class="last-seen">2h ago</span>
                        </div>
                    </li>
                    <li>
                        <div class="user-avatar" style="background: linear-gradient(135deg, #d4fc79, #96e6a1);">E</div>
                        <div class="user-details">
                            <h3>Emma Davis</h3>
                            <p>+1 (555) 456-7890</p>
                        </div>
                        <div class="user-status">
                            <div class="online-dot"></div>
                            <span class="last-seen">Online</span>
                        </div>
                    </li>
                `;
            }
        }, 1000);
    </script>
</body>
</html>
