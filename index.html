<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FireChat Messenger</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
            overflow: hidden;
        }

        /* App Container */
        #app-container {
            width: 100%;
            max-width: 1000px;
            height: 90vh;
            display: flex;
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.3);
        }

        /* Intro Page Styles */
        #intro-page {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            width: 100%;
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1000;
            height: 100vh;
            animation: fadeOut 1s ease-in-out 3s forwards;
        }

        #intro-page h1 {
            font-size: 3.5rem;
            color: #fff;
            text-shadow: 2px 2px 10px rgba(0, 0, 0, 0.3);
            animation: zoomIn 1s ease-in-out;
            margin-bottom: 15px;
        }

        #intro-page p {
            font-size: 1.1rem;
            color: rgba(255, 255, 255, 0.8);
            margin-top: 5px;
            animation: fadeIn 1s ease-in-out;
        }

        .intro-logo {
            width: 130px;
            height: 130px;
            background: linear-gradient(135deg, #4facfe, #00f2fe);
            border-radius: 30%;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            animation: float 3s ease-in-out infinite;
        }

        .intro-logo i {
            font-size: 60px;
            color: white;
        }

        @keyframes zoomIn {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; visibility: hidden; }
        }

        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-15px); }
            100% { transform: translateY(0px); }
        }

        /* Auth Page Styles */
        #auth-page {
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            width: 100%;
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            position: absolute;
            top: 0;
            left: 0;
            z-index: 999;
            height: 100vh;
            animation: fadeIn 0.5s ease-in-out;
        }

        .auth-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 35px;
            width: 90%;
            max-width: 380px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        #auth-page h2 {
            font-size: 2rem;
            color: #fff;
            margin-bottom: 25px;
            font-weight: 600;
        }

        .input-group {
            position: relative;
            margin-bottom: 18px;
        }

        #auth-page input {
            padding: 14px 20px 14px 50px;
            font-size: 0.95rem;
            border: none;
            border-radius: 50px;
            outline: none;
            width: 100%;
            background: rgba(255, 255, 255, 0.15);
            color: white;
            transition: all 0.3s ease;
        }

        #auth-page input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        #auth-page input:focus {
            background: rgba(255, 255, 255, 0.25);
            box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.3);
        }

        .input-icon {
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            color: rgba(255, 255, 255, 0.7);
        }

        #auth-page button {
            padding: 14px;
            font-size: 1rem;
            background: linear-gradient(135deg, #4facfe, #00f2fe);
            color: white;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            width: 100%;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        #auth-page button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        }

        #toggle-auth {
            margin-top: 18px;
            color: rgba(255, 255, 255, 0.8);
            cursor: pointer;
            text-decoration: none;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        #toggle-auth:hover {
            color: white;
            text-decoration: underline;
        }

        #continue-as {
            margin-top: 18px;
            padding: 14px;
            font-size: 0.95rem;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            width: 100%;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        #continue-as:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-3px);
        }

        .continue-as-avatar {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background-size: cover;
            background-position: center;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 13px;
        }

        /* Profile picture preview */
        #profile-pic-preview {
            width: 75px;
            height: 75px;
            border-radius: 50%;
            margin: 10px auto;
            background-size: cover;
            background-position: center;
            border: 2px solid rgba(255, 255, 255, 0.3);
            display: none;
        }

        /* Verification badge */
        .verified-badge {
            color: #1da1f2;
            margin-left: 5px;
            font-size: 0.9rem;
        }

        /* Chat Menu Page Styles */
        #chat-menu-page {
            display: none;
            flex-direction: column;
            height: 100%;
            width: 100%;
            background: rgba(25, 25, 40, 0.95);
            z-index: 998;
            animation: fadeIn 0.5s ease-in-out;
            overflow: hidden;
        }

        .menu-header {
            padding: 18px;
            background: rgba(35, 35, 55, 0.95);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .menu-header h2 {
            font-size: 1.6rem;
            color: white;
            font-weight: 600;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-weight: bold;
            font-size: 1.1rem;
            background-size: cover;
            background-position: center;
        }

        .user-name {
            color: white;
            font-weight: 600;
            font-size: 1rem;
        }

        .logout-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: rgba(255, 255, 255, 0.8);
            width: 38px;
            height: 38px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.1rem;
        }

        .logout-btn:hover {
            background: rgba(255, 80, 80, 0.2);
            color: white;
        }

        .menu-tabs {
            display: flex;
            padding: 0 18px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .menu-tab {
            padding: 12px 0;
            margin-right: 20px;
            color: rgba(255, 255, 255, 0.6);
            cursor: pointer;
            position: relative;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .menu-tab.active {
            color: white;
        }

        .menu-tab.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(135deg, #4facfe, #00f2fe);
            border-radius: 3px;
        }

        #user-list {
            list-style: none;
            padding: 18px;
            width: 100%;
            height: 100%;
            overflow-y: auto;
        }

        #user-list li {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 14px;
            margin-bottom: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 14px;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        #user-list li:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(5px);
        }

        .user-details {
            flex: 1;
        }

        .user-details h3 {
            color: white;
            font-size: 1rem;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
        }

        .user-details p {
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.85rem;
        }

        .user-status {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }

        .online-dot {
            width: 9px;
            height: 9px;
            background-color: #00e676;
            border-radius: 50%;
            margin-bottom: 4px;
        }

        .last-seen {
            color: rgba(255, 255, 255, 0.4);
            font-size: 0.75rem;
        }

        .request-status {
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .status-pending {
            background: rgba(255, 193, 7, 0.2);
            color: #ffc107;
        }

        .status-accepted {
            background: rgba(76, 175, 80, 0.2);
            color: #4caf50;
        }

        .status-rejected {
            background: rgba(244, 67, 54, 0.2);
            color: #f44336;
        }

        .action-button {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-send {
            background: rgba(33, 150, 243, 0.2);
            color: #2196f3;
        }

        .btn-accept {
            background: rgba(76, 175, 80, 0.2);
            color: #4caf50;
            margin-right: 8px;
        }

        .btn-reject {
            background: rgba(244, 67, 54, 0.2);
            color: #f44336;
        }

        /* Request card */
        .request-card {
            display: flex;
            align-items: center;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 14px;
            margin-bottom: 10px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .request-actions {
            margin-left: auto;
            display: flex;
            gap: 8px;
        }

        /* Main Chat Page Styles */
        #main-content {
            display: none;
            flex-direction: column;
            width: 100%;
            height: 100%;
            animation: fadeIn 0.5s ease-in-out;
            background: rgba(30, 30, 45, 0.95);
        }

        #chat-header {
            width: 100%;
            background: rgba(35, 35, 55, 0.95);
            padding: 14px 18px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .chat-partner {
            display: flex;
            align-items: center;
            gap: 14px;
        }

        .chat-partner-avatar {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-weight: bold;
            font-size: 1rem;
            background-size: cover;
            background-position: center;
        }

        .partner-info h3 {
            color: white;
            font-size: 1.1rem;
            margin-bottom: 3px;
            display: flex;
            align-items: center;
        }

        .partner-info p {
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.85rem;
        }

        .chat-actions {
            display: flex;
            gap: 12px;
        }

        .chat-action-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: rgba(255, 255, 255, 0.8);
            width: 38px;
            height: 38px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1rem;
        }

        .chat-action-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        #chat-box {
            width: 100%;
            height: calc(100% - 130px);
            overflow-y: auto;
            padding: 18px;
            display: flex;
            flex-direction: column;
            gap: 14px;
            flex-grow: 1;
            overscroll-behavior: contain;
        }

        .message {
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 14px 18px;
            max-width: 80%;
            font-size: 15px;
            color: white;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            word-wrap: break-word;
            position: relative;
            animation: fadeIn 0.3s ease-out;
        }

        .sent {
            background: linear-gradient(135deg, #4facfe, #00f2fe);
            align-self: flex-end;
            border-bottom-right-radius: 5px;
        }

        .received {
            background: rgba(255, 255, 255, 0.15);
            align-self: flex-start;
            border-bottom-left-radius: 5px;
        }

        .message-content {
            margin-bottom: 4px;
            line-height: 1.5;
        }

        .timestamp {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.6);
            text-align: right;
        }

        .date-label {
            text-align: center;
            font-size: 13px;
            color: rgba(255, 255, 255, 0.4);
            margin: 18px 0;
            position: relative;
        }

        .date-label::before,
        .date-label::after {
            content: '';
            position: absolute;
            top: 50%;
            width: 30%;
            height: 1px;
            background: rgba(255, 255, 255, 0.1);
        }

        .date-label::before {
            left: 0;
        }

        .date-label::after {
            right: 0;
        }

        .message-input-container {
            display: flex;
            width: 100%;
            padding: 14px 18px;
            background: rgba(35, 35, 55, 0.95);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
        }

        .input-wrapper {
            display: flex;
            flex-grow: 1;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 30px;
            padding: 5px 14px;
            align-items: center;
        }

        .input-actions {
            display: flex;
            gap: 8px;
        }

        .action-btn {
            background: transparent;
            border: none;
            color: rgba(255, 255, 255, 0.7);
            width: 38px;
            height: 38px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.1rem;
        }

        .action-btn:hover {
            color: white;
            background: rgba(255, 255, 255, 0.1);
        }

        #message {
            flex-grow: 1;
            padding: 11px;
            font-size: 15px;
            border: none;
            outline: none;
            background: transparent;
            color: white;
        }

        #message::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        #sendBtn {
            padding: 11px 18px;
            font-size: 15px;
            background: linear-gradient(135deg, #4facfe, #00f2fe);
            color: white;
            border: none;
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.1rem;
            width: 42px;
            height: 42px;
            margin-left: 10px;
        }

        #sendBtn:hover {
            transform: scale(1.05);
        }

        /* Notification System */
        #notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: #fff;
            padding: 14px 22px;
            border-radius: 10px;
            display: none;
            z-index: 1001;
            animation: slideInRight 0.5s ease-in-out;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        /* Typing Indicator */
        .typing-indicator {
            display: none;
            align-items: center;
            padding: 9px 14px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            margin: 5px 0 9px;
            align-self: flex-start;
            width: auto;
            max-width: 110px;
            animation: fadeIn 0.3s ease;
        }

        .typing-dots {
            display: flex;
            gap: 4px;
        }

        .typing-dot {
            width: 7px;
            height: 7px;
            background: rgba(255, 255, 255, 0.6);
            border-radius: 50%;
            animation: typing 1.5s infinite;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-4px); }
        }

        /* Emoji Picker */
        #emoji-picker {
            position: absolute;
            bottom: 65px;
            right: 20px;
            background: rgba(50, 50, 70, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 14px;
            width: 280px;
            height: 230px;
            overflow-y: auto;
            display: none;
            z-index: 100;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .emoji-category {
            margin-bottom: 14px;
        }

        .emoji-category h4 {
            color: rgba(255, 255, 255, 0.7);
            font-size: 13px;
            margin-bottom: 9px;
            padding-bottom: 4px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .emoji-grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 7px;
        }

        .emoji {
            font-size: 1.4rem;
            cursor: pointer;
            text-align: center;
            transition: transform 0.2s;
        }

        .emoji:hover {
            transform: scale(1.3);
        }

        /* Keyframes for Animations */
        @keyframes slideInDown {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        @keyframes slideInUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        @keyframes slideInRight {
            from { transform: translateX(50px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            #app-container {
                height: 95vh;
            }
            
            .auth-card {
                padding: 25px 18px;
            }
            
            #intro-page h1 {
                font-size: 2.2rem;
            }
            
            .intro-logo {
                width: 100px;
                height: 100px;
            }
            
            .intro-logo i {
                font-size: 45px;
            }
            
            .menu-header h2 {
                font-size: 1.3rem;
            }
            
            .user-avatar {
                width: 36px;
                height: 36px;
                font-size: 0.9rem;
            }
            
            .user-name {
                font-size: 0.9rem;
            }
            
            #continue-as {
                padding: 11px;
                font-size: 0.85rem;
            }
            
            #emoji-picker {
                width: 260px;
                height: 210px;
                right: 10px;
            }
            
            .emoji-grid {
                grid-template-columns: repeat(7, 1fr);
            }
        }
    </style>
</head>
<body>
    <div id="app-container">
        <!-- Intro Page -->
        <div id="intro-page">
            <div class="intro-logo">
                <i class="fas fa-fire"></i>
            </div>
            <h1>FireChat</h1>
            <p>Secure Real-time Messenger</p>
            <p>Made By Abdur Rahman</p>
        </div>

        <!-- Auth Page -->
        <div id="auth-page">
            <div class="auth-card">
                <h2 id="auth-title">Sign In</h2>
                
                <!-- Profile picture preview -->
                <div id="profile-pic-preview"></div>
                
                <div class="input-group">
                    <i class="fas fa-phone input-icon"></i>
                    <input type="text" id="phone" placeholder="Phone Number" autocomplete="off">
                </div>
                <div class="input-group">
                    <i class="fas fa-lock input-icon"></i>
                    <input type="password" id="password" placeholder="Password" autocomplete="off">
                </div>
                <div class="input-group" style="display: none;">
                    <i class="fas fa-user input-icon"></i>
                    <input type="text" id="name" placeholder="Full Name" autocomplete="off">
                </div>
                <div class="input-group" style="display: none;">
                    <i class="fas fa-image input-icon"></i>
                    <input type="file" id="profile-pic" placeholder="Profile Picture" accept="image/*">
                </div>
                <div class="input-group" style="display: none;">
                    <i class="fas fa-shield-alt input-icon"></i>
                    <input type="text" id="verification" placeholder="Verification Code (Optional)" autocomplete="off">
                </div>
                <button id="auth-button">Sign In</button>
                <p id="toggle-auth">Don't have an account? Sign Up</p>
                <button id="continue-as" style="display: none;">
                    <div class="continue-as-avatar" id="saved-user-avatar"></div>
                    <span>Continue as <span id="saved-username"></span></span>
                </button>
            </div>
        </div>

        <!-- Chat Menu Page -->
        <div id="chat-menu-page">
            <div class="menu-header">
                <h2>Chats</h2>
                <div class="user-info">
                    <div class="user-avatar" id="current-user-avatar">AR</div>
                    <div class="user-name" id="current-user-name">Loading...</div>
                    <button class="logout-btn">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </div>
            
            <div class="menu-tabs">
                <div class="menu-tab active" data-tab="contacts">Contacts</div>
                <div class="menu-tab" data-tab="requests">Requests</div>
            </div>
            
            <ul id="user-list">
                <!-- Users will be populated dynamically -->
            </ul>
        </div>

        <!-- Main Chat Page -->
        <div id="main-content">
            <div id="chat-header">
                <div class="chat-partner">
                    <button class="back-btn chat-action-btn">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                    <div class="chat-partner-avatar" id="recipient-avatar">U</div>
                    <div class="partner-info">
                        <h3 id="recipient-name">User</h3>
                        <p id="recipient-status">Online</p>
                    </div>
                </div>
                <div class="chat-actions">
                    <!-- Only the back button remains -->
                </div>
            </div>
            <div id="chat-box">
                <!-- Messages will be populated here -->
            </div>
            <div class="message-input-container">
                <div id="emoji-picker">
                    <div class="emoji-category">
                        <h4>Smileys & People</h4>
                        <div class="emoji-grid" id="smileys-people">
                            <!-- Populated with JS -->
                        </div>
                    </div>
                    <div class="emoji-category">
                        <h4>Animals & Nature</h4>
                        <div class="emoji-grid" id="animals-nature">
                            <!-- Populated with JS -->
                        </div>
                    </div>
                    <div class="emoji-category">
                        <h4>Food & Drink</h4>
                        <div class="emoji-grid" id="food-drink">
                            <!-- Populated with JS -->
                        </div>
                    </div>
                </div>
                <div class="input-wrapper">
                    <button class="action-btn" id="emoji-btn">
                        <i class="fas fa-smile"></i>
                    </button>
                    <input type="text" id="message" placeholder="Type a message..." autocomplete="off">
                </div>
                <button id="sendBtn">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>

        <!-- Notification System -->
        <div id="notification"></div>
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCTsAz5S3wfA-MVf6Cg0fIhgIJpXJVtUeM",
            authDomain: "firechat-1db95.firebaseapp.com",
            projectId: "firechat-1db95",
            storageBucket: "firechat-1db95.appspot.com",
            messagingSenderId: "415882699232",
            appId: "1:415882699232:web:9bff72b320ad3d2f14cb85",
            measurementId: "G-HS72PGXV62"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Emoji categories
        const emojiCategories = {
            "smileys-people": ["ðŸ˜€", "ðŸ˜ƒ", "ðŸ˜„", "ðŸ˜", "ðŸ˜†", "ðŸ˜…", "ðŸ˜‚", "ðŸ¤£", "ðŸ˜Š", "ðŸ˜‡", "ðŸ™‚", "ðŸ™ƒ", "ðŸ˜‰", "ðŸ˜Œ", "ðŸ˜", "ðŸ¥°", "ðŸ˜˜", "ðŸ˜—", "ðŸ˜™", "ðŸ˜š", "ðŸ˜‹", "ðŸ˜›", "ðŸ˜", "ðŸ˜œ", "ðŸ¤ª", "ðŸ¤¨", "ðŸ§", "ðŸ¤“", "ðŸ˜Ž", "ðŸ¤©", "ðŸ¥³", "ðŸ˜", "ðŸ˜’", "ðŸ˜ž", "ðŸ˜”", "ðŸ˜Ÿ", "ðŸ˜•", "ðŸ™", "â˜¹ï¸", "ðŸ˜£", "ðŸ˜–", "ðŸ˜«", "ðŸ˜©", "ðŸ¥º", "ðŸ˜¢", "ðŸ˜­", "ðŸ˜¤", "ðŸ˜ ", "ðŸ˜¡", "ðŸ¤¬", "ðŸ¤¯", "ðŸ˜³", "ðŸ¥µ", "ðŸ¥¶", "ðŸ˜±", "ðŸ˜¨", "ðŸ˜°", "ðŸ˜¥", "ðŸ˜“", "ðŸ¤—", "ðŸ¤”", "ðŸ¤­", "ðŸ¤«", "ðŸ¤¥", "ðŸ˜¶", "ðŸ˜", "ðŸ˜‘", "ðŸ˜¬", "ðŸ™„", "ðŸ˜¯", "ðŸ˜¦", "ðŸ˜§", "ðŸ˜®", "ðŸ˜²", "ðŸ¥±", "ðŸ˜´", "ðŸ¤¤", "ðŸ˜ª", "ðŸ˜µ", "ðŸ¤", "ðŸ¥´", "ðŸ¤¢", "ðŸ¤®", "ðŸ¤§", "ðŸ˜·", "ðŸ¤’", "ðŸ¤•"],
            "animals-nature": ["ðŸ¶", "ðŸ±", "ðŸ­", "ðŸ¹", "ðŸ°", "ðŸ¦Š", "ðŸ»", "ðŸ¼", "ðŸ¨", "ðŸ¯", "ðŸ¦", "ðŸ®", "ðŸ·", "ðŸ½", "ðŸ¸", "ðŸµ", "ðŸ™ˆ", "ðŸ™‰", "ðŸ™Š", "ðŸ’", "ðŸ”", "ðŸ§", "ðŸ¦", "ðŸ¤", "ðŸ£", "ðŸ¥", "ðŸ¦†", "ðŸ¦…", "ðŸ¦‰", "ðŸ¦‡", "ðŸº", "ðŸ—", "ðŸ´", "ðŸ¦„", "ðŸ", "ðŸ›", "ðŸ¦‹", "ðŸŒ", "ðŸž", "ðŸœ", "ðŸ¦Ÿ", "ðŸ¦—", "ðŸ•·", "ðŸ¦‚", "ðŸ¢", "ðŸ", "ðŸ¦Ž", "ðŸ¦–", "ðŸ¦•", "ðŸ™", "ðŸ¦‘", "ðŸ¦", "ðŸ¦ž", "ðŸ¦€", "ðŸ¡", "ðŸ ", "ðŸŸ", "ðŸ¬", "ðŸ³", "ðŸ‹", "ðŸ¦ˆ", "ðŸŠ", "ðŸ…", "ðŸ†", "ðŸ¦“", "ðŸ¦", "ðŸ¦§", "ðŸ¦£", "ðŸ˜", "ðŸ¦›", "ðŸ¦", "ðŸª", "ðŸ«", "ðŸ¦’", "ðŸ¦˜", "ðŸ¦¬", "ðŸƒ", "ðŸ‚", "ðŸ„", "ðŸŽ", "ðŸ–", "ðŸ", "ðŸ‘", "ðŸ¦™", "ðŸ", "ðŸ¦Œ", "ðŸ•", "ðŸ©", "ðŸ¦®", "ðŸ•â€ðŸ¦º", "ðŸˆ", "ðŸˆâ€â¬›", "ðŸ“", "ðŸ¦ƒ", "ðŸ¦š", "ðŸ¦œ", "ðŸ¦¢", "ðŸ¦©", "ðŸ•Š", "ðŸ‡", "ðŸ¦", "ðŸ¦¨", "ðŸ¦¡", "ðŸ¦«", "ðŸ¦¦", "ðŸ¦¥", "ðŸ", "ðŸ€", "ðŸ¿", "ðŸ¦”"],
            "food-drink": ["ðŸ", "ðŸŽ", "ðŸ", "ðŸŠ", "ðŸ‹", "ðŸŒ", "ðŸ‰", "ðŸ‡", "ðŸ“", "ðŸ«", "ðŸˆ", "ðŸ’", "ðŸ‘", "ðŸ¥­", "ðŸ", "ðŸ¥¥", "ðŸ¥", "ðŸ…", "ðŸ†", "ðŸ¥‘", "ðŸ¥¦", "ðŸ¥¬", "ðŸ¥’", "ðŸŒ¶", "ðŸ«‘", "ðŸŒ½", "ðŸ¥•", "ðŸ«’", "ðŸ§„", "ðŸ§…", "ðŸ¥”", "ðŸ ", "ðŸ¥", "ðŸ¥¯", "ðŸž", "ðŸ¥–", "ðŸ¥¨", "ðŸ§€", "ðŸ¥š", "ðŸ³", "ðŸ§ˆ", "ðŸ¥ž", "ðŸ§‡", "ðŸ¥“", "ðŸ¥©", "ðŸ—", "ðŸ–", "ðŸ¦´", "ðŸŒ­", "ðŸ”", "ðŸŸ", "ðŸ•", "ðŸ«“", "ðŸ¥ª", "ðŸ¥™", "ðŸ§†", "ðŸŒ®", "ðŸŒ¯", "ðŸ«”", "ðŸ¥—", "ðŸ¥˜", "ðŸ«•", "ðŸ¥«", "ðŸ", "ðŸœ", "ðŸ²", "ðŸ›", "ðŸ£", "ðŸ±", "ðŸ¥Ÿ", "ðŸ¦ª", "ðŸ¤", "ðŸ™", "ðŸš", "ðŸ˜", "ðŸ¥", "ðŸ¥ ", "ðŸ¥®", "ðŸ¢", "ðŸ¡", "ðŸ§", "ðŸ¨", "ðŸ¦", "ðŸ¥§", "ðŸ§", "ðŸ°", "ðŸŽ‚", "ðŸ®", "ðŸ­", "ðŸ¬", "ðŸ«", "ðŸ¿", "ðŸ©", "ðŸª", "ðŸŒ°", "ðŸ¥œ", "ðŸ¯", "ðŸ¥›", "ðŸ¼", "ðŸ«–", "â˜•", "ðŸµ", "ðŸ§ƒ", "ðŸ¥¤", "ðŸ§‹", "ðŸ¶", "ðŸº", "ðŸ»", "ðŸ¥‚", "ðŸ·", "ðŸ¥ƒ", "ðŸ¸", "ðŸ¹", "ðŸ§‰", "ðŸ¾", "ðŸ§Š"]
        };

        // DOM Elements
        const introPage = document.getElementById('intro-page');
        const authPage = document.getElementById('auth-page');
        const chatMenuPage = document.getElementById('chat-menu-page');
        const mainContent = document.getElementById('main-content');
        const notification = document.getElementById('notification');
        const authButton = document.getElementById('auth-button');
        const toggleAuth = document.getElementById('toggle-auth');
        const continueAsButton = document.getElementById('continue-as');
        const savedUsername = document.getElementById('saved-username');
        const savedUserAvatar = document.getElementById('saved-user-avatar');
        const backBtn = document.querySelector('.back-btn');
        const sendBtn = document.getElementById('sendBtn');
        const messageInput = document.getElementById('message');
        const chatBox = document.getElementById('chat-box');
        const userList = document.getElementById('user-list');
        const currentUserAvatar = document.getElementById('current-user-avatar');
        const currentUserName = document.getElementById('current-user-name');
        const recipientName = document.getElementById('recipient-name');
        const recipientAvatar = document.getElementById('recipient-avatar');
        const recipientStatus = document.getElementById('recipient-status');
        const logoutBtn = document.querySelector('.logout-btn');
        const profilePicInput = document.getElementById('profile-pic');
        const profilePicPreview = document.getElementById('profile-pic-preview');
        const emojiBtn = document.getElementById('emoji-btn');
        const emojiPicker = document.getElementById('emoji-picker');
        const menuTabs = document.querySelectorAll('.menu-tab');
        const verificationInput = document.getElementById('verification').parentElement;

        // App State
        let currentUser = null;
        let currentChatId = null;
        let currentRecipient = null;
        let isSignUp = false;
        let unsubscribeMessages = null;
        let currentTab = 'contacts';

        // Show auth page after intro page
        setTimeout(() => {
            introPage.style.display = 'none';
            authPage.style.display = 'flex';
        }, 3000);

        // Show notification
        function showNotification(message, duration = 3000) {
            notification.textContent = message;
            notification.style.display = 'block';
            setTimeout(() => {
                notification.style.display = 'none';
            }, duration);
        }

        // Toggle between Sign In and Sign Up
        const authTitle = document.getElementById('auth-title');
        const nameInput = document.querySelector('#name').parentElement;
        const profilePicContainer = document.querySelector('#profile-pic').parentElement;

        toggleAuth.addEventListener('click', () => {
            isSignUp = !isSignUp;
            authTitle.textContent = isSignUp ? "Sign Up" : "Sign In";
            authButton.textContent = isSignUp ? "Sign Up" : "Sign In";
            toggleAuth.textContent = isSignUp ? "Already have an account? Sign In" : "Don't have an account? Sign Up";
            nameInput.style.display = isSignUp ? 'block' : 'none';
            profilePicContainer.style.display = isSignUp ? 'block' : 'none';
            verificationInput.style.display = isSignUp ? 'block' : 'none';
        });

        // Profile picture preview
        profilePicInput.addEventListener('change', function() {
            if (this.files && this.files[0]) {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    profilePicPreview.style.backgroundImage = `url(${e.target.result})`;
                    profilePicPreview.style.display = 'block';
                }
                
                reader.readAsDataURL(this.files[0]);
            }
        });

        // Initialize emoji picker
        function initEmojiPicker() {
            for (const category in emojiCategories) {
                const container = document.getElementById(category);
                container.innerHTML = '';
                
                emojiCategories[category].forEach(emoji => {
                    const emojiEl = document.createElement('div');
                    emojiEl.className = 'emoji';
                    emojiEl.textContent = emoji;
                    emojiEl.addEventListener('click', () => {
                        messageInput.value += emoji;
                        messageInput.focus();
                    });
                    container.appendChild(emojiEl);
                });
            }
        }

        // Toggle emoji picker
        emojiBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            emojiPicker.style.display = emojiPicker.style.display === 'block' ? 'none' : 'block';
        });

        // Close emoji picker when clicking outside
        document.addEventListener('click', (e) => {
            if (!emojiPicker.contains(e.target) && e.target !== emojiBtn) {
                emojiPicker.style.display = 'none';
            }
        });

        // Optimize and compress image
        async function optimizeImage(file) {
            return new Promise((resolve, reject) => {
                if (file.size < 500 * 1024) {
                    const reader = new FileReader();
                    reader.onload = (e) => resolve(e.target.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                    return;
                }
                
                const img = new Image();
                const url = URL.createObjectURL(file);
                
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    let width = img.width;
                    let height = img.height;
                    const maxSize = 800;
                    
                    if (width > height) {
                        if (width > maxSize) {
                            height *= maxSize / width;
                            width = maxSize;
                        }
                    } else {
                        if (height > maxSize) {
                            width *= maxSize / height;
                            height = maxSize;
                        }
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    const compressedDataUrl = canvas.toDataURL('image/jpeg', 0.7);
                    URL.revokeObjectURL(url);
                    resolve(compressedDataUrl);
                };
                
                img.onerror = reject;
                img.src = url;
            });
        }

        // Handle Sign Up
        async function handleSignUp(phone, password, name, profilePic, verificationCode) {
            try {
                // Check if user already exists
                const userDoc = await db.collection('users').doc(phone).get();
                
                if (userDoc.exists) {
                    throw new Error('User with this phone number already exists');
                }
                
                // Create new user
                const verification = verificationCode === 'V123' ? { type: "V", verifiedAt: new Date() } : null;
                
                await db.collection('users').doc(phone).set({
                    name,
                    password,
                    phone,
                    Pic: profilePic || '',
                    verification,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                return { phone, name, Pic: profilePic, verification };
            } catch (error) {
                console.error("Error signing up:", error);
                throw error;
            }
        }

        // Handle Sign In
        async function handleSignIn(phone, password) {
            try {
                const userDoc = await db.collection('users').doc(phone).get();
                if (!userDoc.exists) {
                    throw new Error('User not found');
                }
                
                const userData = userDoc.data();
                if (userData.password !== password) {
                    throw new Error('Incorrect password');
                }
                
                return userData;
            } catch (error) {
                console.error("Error signing in:", error);
                throw error;
            }
        }

        // Helper function to update avatar display
        function updateAvatar(element, user) {
            element.textContent = '';
            element.style.backgroundImage = '';
            element.style.background = '';
            
            if (user.Pic) {
                element.style.backgroundImage = `url(${user.Pic})`;
            } else {
                element.style.background = getRandomGradient();
                element.textContent = user.name.charAt(0).toUpperCase();
            }
        }

        // Auth button click handler
        authButton.addEventListener('click', async () => {
            const phone = document.getElementById('phone').value.trim();
            const password = document.getElementById('password').value.trim();
            const name = document.getElementById('name').value.trim();
            const profilePicFile = document.getElementById('profile-pic').files[0];
            const verificationCode = document.getElementById('verification').value.trim();
            
            // Validate inputs
            if (!phone || !password || (isSignUp && !name)) {
                showNotification("Please fill in all fields.");
                return;
            }
            
            // Validate phone format
            if (!/^\d+$/.test(phone)) {
                showNotification("Please enter a valid phone number (digits only)");
                return;
            }
            
            try {
                if (isSignUp) {
                    // Handle sign up
                    let profilePic = null;
                    if (profilePicFile) {
                        profilePic = await optimizeImage(profilePicFile);
                    }
                    
                    const user = await handleSignUp(phone, password, name, profilePic, verificationCode);
                    
                    // Update UI
                    currentUser = user;
                    
                    // Set avatar
                    updateAvatar(currentUserAvatar, currentUser);
                    
                    currentUserName.textContent = currentUser.name;
                    
                    // Save to localStorage for auto-login
                    localStorage.setItem('firechat_user', JSON.stringify({
                        phone,
                        name,
                        Pic: profilePic || '',
                        password: password,
                        verification: user.verification
                    }));
                    
                    showNotification("Account created successfully!");
                    
                    // Switch to chat menu
                    authPage.style.display = 'none';
                    chatMenuPage.style.display = 'flex';
                    
                    // Load user list
                    loadUserList();
                } else {
                    // Handle sign in
                    const userData = await handleSignIn(phone, password);
                    
                    // Update UI and state
                    currentUser = userData;
                    
                    // Set avatar
                    updateAvatar(currentUserAvatar, currentUser);
                    
                    currentUserName.textContent = currentUser.name;
                    
                    // Save to localStorage for auto-login
                    localStorage.setItem('firechat_user', JSON.stringify({
                        phone,
                        name: currentUser.name,
                        Pic: currentUser.Pic || '',
                        password: password,
                        verification: currentUser.verification
                    }));
                    
                    showNotification("Signed in successfully!");
                    
                    // Switch to chat menu
                    authPage.style.display = 'none';
                    chatMenuPage.style.display = 'flex';
                    
                    // Load user list
                    loadUserList();
                }
            } catch (error) {
                console.error("Authentication error:", error);
                showNotification(error.message || "Authentication failed. Please try again.");
            }
        });

        // Helper function for random gradient
        function getRandomGradient() {
            const gradients = [
                'linear-gradient(135deg, #ff9a9e, #fad0c4)',
                'linear-gradient(135deg, #a1c4fd, #c2e9fb)',
                'linear-gradient(135deg, #d4fc79, #96e6a1)',
                'linear-gradient(135deg, #f6d365, #fda085)',
                'linear-gradient(135deg, #84fab0, #8fd3f4)'
            ];
            return gradients[Math.floor(Math.random() * gradients.length)];
        }

        // Auto-login with saved credentials
        const savedUser = JSON.parse(localStorage.getItem('firechat_user'));
        if (savedUser) {
            continueAsButton.style.display = 'flex';
            savedUsername.textContent = savedUser.name;
            
            // Set avatar for continue as button
            if (savedUser.Pic) {
                savedUserAvatar.style.backgroundImage = `url(${savedUser.Pic})`;
            } else {
                savedUserAvatar.style.background = getRandomGradient();
                savedUserAvatar.textContent = savedUser.name.charAt(0).toUpperCase();
            }
            
            continueAsButton.addEventListener('click', async () => {
                try {
                    const userData = await handleSignIn(savedUser.phone, savedUser.password);
                    
                    if (!userData) {
                        throw new Error("User data not found");
                    }
                    
                    currentUser = userData;
                    
                    // Set avatar
                    updateAvatar(currentUserAvatar, currentUser);
                    
                    currentUserName.textContent = currentUser.name;
                    
                    showNotification("Welcome back, " + currentUser.name + "!");
                    authPage.style.display = 'none';
                    chatMenuPage.style.display = 'flex';
                    
                    // Load user list
                    loadUserList();
                } catch (error) {
                    console.error("Auto-login error:", error);
                    showNotification("Auto-login failed. Please sign in manually.");
                }
            });
        }

        // Toggle menu tabs
        menuTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                menuTabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                currentTab = tab.dataset.tab;
                loadUserList();
            });
        });

        // Send chat request
        async function sendChatRequest(receiverPhone) {
            try {
                // Check if request already exists
                const existingRequest = await db.collection('chat_requests')
                    .where('senderId', '==', currentUser.phone)
                    .where('receiverId', '==', receiverPhone)
                    .get();
                
                if (!existingRequest.empty) {
                    showNotification("Request already sent");
                    return;
                }
                
                // Create new request
                await db.collection('chat_requests').add({
                    senderId: currentUser.phone,
                    receiverId: receiverPhone,
                    status: 'pending',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                showNotification("Chat request sent!");
                loadUserList();
            } catch (error) {
                console.error("Error sending chat request:", error);
                showNotification("Failed to send request.");
            }
        }

        // Handle chat request response
        async function handleChatRequest(requestId, status) {
            try {
                const requestRef = db.collection('chat_requests').doc(requestId);
                await requestRef.update({ status });
                
                if (status === 'accepted') {
                    // Create chat when request is accepted
                    const requestDoc = await requestRef.get();
                    const request = requestDoc.data();
                    
                    // Check if chat already exists
                    const chatsQuery = await db.collection('chats')
                        .where('participants', 'array-contains', currentUser.phone)
                        .get();
                    
                    let chatExists = false;
                    
                    chatsQuery.forEach(doc => {
                        const chat = doc.data();
                        if (chat.participants.includes(request.senderId)) {
                            chatExists = true;
                            currentChatId = doc.id;
                        }
                    });
                    
                    // Create new chat if doesn't exist
                    if (!chatExists) {
                        // Get sender user data
                        const senderDoc = await db.collection('users').doc(request.senderId).get();
                        const senderData = senderDoc.data();
                        
                        const newChat = {
                            participants: [currentUser.phone, request.senderId],
                            names: {
                                [currentUser.phone]: currentUser.name,
                                [request.senderId]: senderData.name
                            },
                            verifiedChat: currentUser.verification?.type === "V" && senderData.verification?.type === "V",
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            lastMessage: '',
                            lastMessageTime: firebase.firestore.FieldValue.serverTimestamp()
                        };
                        
                        const chatRef = await db.collection('chats').add(newChat);
                        currentChatId = chatRef.id;
                    }
                    
                    showNotification("Chat request accepted!");
                } else {
                    showNotification("Chat request rejected");
                }
                
                loadUserList();
            } catch (error) {
                console.error("Error handling chat request:", error);
                showNotification("Failed to handle request.");
            }
        }

        // Load user list from Firestore
        async function loadUserList() {
            try {
                const usersSnapshot = await db.collection('users').get();
                userList.innerHTML = '';
                
                // Get all chat requests involving current user
                const sentRequests = await db.collection('chat_requests').where('senderId', '==', currentUser.phone).get();
                const receivedRequests = await db.collection('chat_requests').where('receiverId', '==', currentUser.phone).get();
                
                const allRequests = [];
                sentRequests.forEach(doc => allRequests.push({ id: doc.id, ...doc.data() }));
                receivedRequests.forEach(doc => allRequests.push({ id: doc.id, ...doc.data() }));
                
                if (currentTab === 'requests') {
                    // Show pending requests
                    const pendingRequests = allRequests.filter(req => 
                        req.receiverId === currentUser.phone && req.status === 'pending'
                    );
                    
                    if (pendingRequests.length === 0) {
                        userList.innerHTML = '<li class="no-requests">No pending requests</li>';
                    } else {
                        for (const request of pendingRequests) {
                            const senderDoc = await db.collection('users').doc(request.senderId).get();
                            const senderData = senderDoc.data();
                            
                            const li = document.createElement('li');
                            li.className = 'request-card';
                            
                            // Create avatar
                            const avatarDiv = document.createElement('div');
                            avatarDiv.className = 'user-avatar';
                            if (senderData.Pic) {
                                avatarDiv.style.backgroundImage = `url(${senderData.Pic})`;
                            } else {
                                avatarDiv.style.background = getRandomGradient();
                                avatarDiv.textContent = senderData.name.charAt(0).toUpperCase();
                            }
                            
                            // Create user details
                            const userDetailsDiv = document.createElement('div');
                            userDetailsDiv.className = 'user-details';
                            userDetailsDiv.innerHTML = `
                                <h3>${senderData.name} 
                                    ${senderData.verification?.type === 'V' 
                                        ? '<span class="verified-badge"><i class="fas fa-check-circle"></i></span>' 
                                        : ''}
                                </h3>
                                <p>${senderData.phone}</p>
                            `;
                            
                            // Create request actions
                            const actionsDiv = document.createElement('div');
                            actionsDiv.className = 'request-actions';
                            actionsDiv.innerHTML = `
                                <button class="action-button btn-accept" data-action="accept" data-request="${request.id}">
                                    <i class="fas fa-check"></i> Accept
                                </button>
                                <button class="action-button btn-reject" data-action="reject" data-request="${request.id}">
                                    <i class="fas fa-times"></i> Reject
                                </button>
                            `;
                            
                            // Append elements
                            li.appendChild(avatarDiv);
                            li.appendChild(userDetailsDiv);
                            li.appendChild(actionsDiv);
                            
                            userList.appendChild(li);
                        }
                    }
                    
                    // Add event listeners to action buttons
                    document.querySelectorAll('.action-button').forEach(button => {
                        button.addEventListener('click', (e) => {
                            const action = e.target.dataset.action;
                            const requestId = e.target.dataset.request;
                            handleChatRequest(requestId, action === 'accept' ? 'accepted' : 'rejected');
                        });
                    });
                    
                    return;
                }
                
                // Show contacts
                usersSnapshot.forEach(doc => {
                    const user = doc.data();
                    
                    // Skip current user
                    if (user.phone === currentUser.phone) return;
                    
                    const li = document.createElement('li');
                    
                    // Create avatar
                    const avatarDiv = document.createElement('div');
                    avatarDiv.className = 'user-avatar';
                    if (user.Pic) {
                        avatarDiv.style.backgroundImage = `url(${user.Pic})`;
                    } else {
                        avatarDiv.style.background = getRandomGradient();
                        avatarDiv.textContent = user.name.charAt(0).toUpperCase();
                    }
                    
                    // Create user details
                    const userDetailsDiv = document.createElement('div');
                    userDetailsDiv.className = 'user-details';
                    userDetailsDiv.innerHTML = `
                        <h3>${user.name} 
                            ${user.verification?.type === 'V' 
                                ? '<span class="verified-badge"><i class="fas fa-check-circle"></i></span>' 
                                : ''}
                        </h3>
                        <p>${user.phone}</p>
                    `;
                    
                    // Create user status
                    const userStatusDiv = document.createElement('div');
                    userStatusDiv.className = 'user-status';
                    
                    // Find request status for this user
                    const request = allRequests.find(req => 
                        (req.senderId === currentUser.phone && req.receiverId === user.phone) ||
                        (req.senderId === user.phone && req.receiverId === currentUser.phone)
                    );
                    
                    if (request) {
                        if (request.status === 'accepted') {
                            li.addEventListener('click', () => startChat(user.phone, user));
                            userStatusDiv.innerHTML = `
                                <span class="request-status status-accepted">Chat Active</span>
                            `;
                        } else if (request.senderId === currentUser.phone) {
                            userStatusDiv.innerHTML = `
                                <span class="request-status status-pending">Request Sent</span>
                            `;
                        } else {
                            userStatusDiv.innerHTML = `
                                <span class="request-status status-pending">Request Received</span>
                            `;
                        }
                    } else {
                        const sendButton = document.createElement('button');
                        sendButton.className = 'action-button btn-send';
                        sendButton.innerHTML = '<i class="fas fa-user-plus"></i> Send Request';
                        sendButton.addEventListener('click', (e) => {
                            e.stopPropagation();
                            sendChatRequest(user.phone);
                        });
                        userStatusDiv.appendChild(sendButton);
                    }
                    
                    // Append elements
                    li.appendChild(avatarDiv);
                    li.appendChild(userDetailsDiv);
                    li.appendChild(userStatusDiv);
                    
                    if (!request || request.status === 'accepted') {
                        li.addEventListener('click', () => startChat(user.phone, user));
                    }
                    
                    userList.appendChild(li);
                });
                
                if (userList.children.length === 0) {
                    userList.innerHTML = '<li>No other users available.</li>';
                }
            } catch (error) {
                console.error("Error loading user list:", error);
                showNotification("Failed to load user list.");
            }
        }

        // Start a chat with another user
        async function startChat(recipientPhone, recipientData) {
            try {
                currentRecipient = recipientData;
                
                // Set recipient name with verification badge
                recipientName.innerHTML = `
                    ${currentRecipient.name} 
                    ${currentRecipient.verification?.type === 'V' 
                        ? '<span class="verified-badge"><i class="fas fa-check-circle"></i></span>' 
                        : ''}
                `;
                
                // Set recipient avatar
                recipientAvatar.textContent = '';
                if (currentRecipient.Pic) {
                    recipientAvatar.style.backgroundImage = `url(${currentRecipient.Pic})`;
                } else {
                    recipientAvatar.style.background = getRandomGradient();
                    recipientAvatar.textContent = currentRecipient.name.charAt(0).toUpperCase();
                }
                
                recipientStatus.textContent = 'Online';
                
                // Check if chat already exists
                const chatsQuery = await db.collection('chats')
                    .where('participants', 'array-contains', currentUser.phone)
                    .get();
                
                let chatExists = false;
                
                chatsQuery.forEach(doc => {
                    const chat = doc.data();
                    if (chat.participants.includes(recipientPhone)) {
                        chatExists = true;
                        currentChatId = doc.id;
                    }
                });
                
                if (!chatExists) {
                    // Check if request exists and is accepted
                    const requestQuery = await db.collection('chat_requests')
                        .where('senderId', 'in', [currentUser.phone, recipientPhone])
                        .where('receiverId', 'in', [currentUser.phone, recipientPhone])
                        .where('status', '==', 'accepted')
                        .get();
                    
                    if (!requestQuery.empty) {
                        const request = requestQuery.docs[0].data();
                        const chatRef = await db.collection('chats').add({
                            participants: [currentUser.phone, recipientPhone],
                            names: {
                                [currentUser.phone]: currentUser.name,
                                [recipientPhone]: currentRecipient.name
                            },
                            verifiedChat: currentUser.verification?.type === "V" && currentRecipient.verification?.type === "V",
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            lastMessage: '',
                            lastMessageTime: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        currentChatId = chatRef.id;
                    } else {
                        showNotification("You need to send a chat request first");
                        return;
                    }
                }
                
                // Load messages
                loadMessages();
                
                // Switch to chat view
                chatMenuPage.style.display = 'none';
                mainContent.style.display = 'flex';
            } catch (error) {
                console.error("Error starting chat:", error);
                showNotification("Failed to start chat.");
            }
        }

        // Load messages for current chat
        function loadMessages() {
            // Unsubscribe from previous listener if exists
            if (unsubscribeMessages) {
                unsubscribeMessages();
            }
            
            chatBox.innerHTML = '';
            let lastDate = null;
            
            unsubscribeMessages = db.collection('chats')
                .doc(currentChatId)
                .collection('messages')
                .orderBy('timestamp', 'asc')
                .onSnapshot(snapshot => {
                    chatBox.innerHTML = '';
                    lastDate = null;
                    
                    snapshot.forEach(doc => {
                        const message = doc.data();
                        const messageDate = message.timestamp.toDate().toDateString();
                        
                        // Add date label if new day
                        if (messageDate !== lastDate) {
                            const dateLabel = document.createElement('div');
                            dateLabel.className = 'date-label';
                            dateLabel.textContent = message.timestamp.toDate().toLocaleDateString('en-US', {
                                weekday: 'short',
                                month: 'short',
                                day: 'numeric'
                            });
                            chatBox.appendChild(dateLabel);
                            lastDate = messageDate;
                        }
                        
                        // Create message element
                        const messageElement = document.createElement('div');
                        messageElement.className = `message ${message.sender === currentUser.phone ? 'sent' : 'received'}`;
                        
                        const messageContent = document.createElement('div');
                        messageContent.className = 'message-content';
                        messageContent.textContent = message.text;
                        
                        const timestamp = document.createElement('div');
                        timestamp.className = 'timestamp';
                        timestamp.textContent = message.timestamp.toDate().toLocaleTimeString('en-US', {
                            hour: 'numeric',
                            minute: 'numeric',
                            hour12: true
                        });
                        
                        messageElement.appendChild(messageContent);
                        messageElement.appendChild(timestamp);
                        chatBox.appendChild(messageElement);
                    });
                    
                    // Scroll to bottom
                    chatBox.scrollTop = chatBox.scrollHeight;
                }, error => {
                    console.error("Error loading messages:", error);
                    showNotification("Failed to load messages.");
                });
        }

        // Send a message
        async function sendMessage() {
            const messageText = messageInput.value.trim();
            
            if (!messageText || !currentChatId) return;
            
            try {
                // Add message to Firestore
                await db.collection('chats')
                    .doc(currentChatId)
                    .collection('messages')
                    .add({
                        text: messageText,
                        sender: currentUser.phone,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });
                
                // Update last message in chat
                await db.collection('chats')
                    .doc(currentChatId)
                    .update({
                        lastMessage: messageText,
                        lastMessageTime: firebase.firestore.FieldValue.serverTimestamp()
                    });
                
                // Clear input
                messageInput.value = '';
            } catch (error) {
                console.error("Error sending message:", error);
                showNotification("Failed to send message.");
            }
        }

        // Event listeners
        sendBtn.addEventListener('click', sendMessage);
        messageInput.addEventListener('keypress', e => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        backBtn.addEventListener('click', () => {
            mainContent.style.display = 'none';
            chatMenuPage.style.display = 'flex';
            
            // Unsubscribe from messages when leaving chat
            if (unsubscribeMessages) {
                unsubscribeMessages();
                unsubscribeMessages = null;
            }
        });

        logoutBtn.addEventListener('click', () => {
            localStorage.removeItem('firechat_user');
            currentUser = null;
            currentChatId = null;
            currentRecipient = null;
            
            chatMenuPage.style.display = 'none';
            mainContent.style.display = 'none';
            authPage.style.display = 'flex';
            
            showNotification("You've been signed out");
        });

        // Initialize the app
        function initApp() {
            initEmojiPicker();
        }

        // Initialize when the page loads
        window.addEventListener('load', initApp);
    </script>
</body>
</html>
